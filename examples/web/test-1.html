<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple-Screenshot H5 æˆªå±æ¼”ç¤º</title>
  <link rel="stylesheet" href="./test-1.css" />
  <script>
    (function (win, doc) {
      var docEl = document.documentElement;

      function setFont() {
        var cliWidth = docEl.clientWidth;
        if (cliWidth > 750) {
          cliWidth = 750;
        }
        docEl.style.fontSize = 100 * (cliWidth / 750) + "px";
      }
      win.addEventListener("resize", setFont, false);
      setFont();
    })(window, document);
  </script>
  <style>
    .temp-preview {
      position: fixed;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, .6);
      justify-content: center;
      display: none;
    }

    .temp-preview>div {
      max-width: 560px;
      margin: auto;
      margin-left: .32rem;
      margin-right: .32rem;
      display: flex;
      align-items: center;
    }

    .temp-preview img {
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="mp-share">
    <div class="mps-content">
      <div class="mps-info">
        <div class="mpsi-img" style="
              background-image: url(https://pic2.zhimg.com/80/v2-c73649b7f792be2e8d3b3bfe7c6360fd_720w.jpeg);
            "></div>
        <div class="mpsi-text">
          <div>newbieyoungğŸ˜€</div>
          <div>åˆ†äº«3ä¸ªå¤§å®è´ç»™ä½ </div>
        </div>
      </div>
      <div class="mp-list no-btns">
        <div class="mpl-item">
          <div class="mpl-img">
            <img src="https://pic2.zhimg.com/80/v2-615d289fede62d4e714a35210397e184_720w.png" />
          </div>
          <div class="mpl-detail">
            <div class="mpl-title">
              <div class="mpl-tag">Simple-Crop</div>
              æ”¯æŒè£å‰ªå›¾ç‰‡ä»»æ„è§’åº¦æ—‹è½¬å…¨å¹³å°å›¾ç‰‡è£å‰ªç»„ä»¶
            </div>
            <div class="mpl-features">
              <div class="mpl-sales">ä»»æ„è§’åº¦æ—‹è½¬</div>
              <div>ä½“éªŒåª²ç¾å®¢æˆ·ç«¯</div>
            </div>
            <div class="mpl-info">
              <div class="mpl-save">
                star
                <div>230</div>
              </div>
            </div>
          </div>
        </div>
        <div class="mpl-item">
          <div class="mpl-img">
            <img src="https://pic4.zhimg.com/80/v2-b01d271772cccd9dcd2f139b32abd09e_720w.jpeg" />
          </div>
          <div class="mpl-detail">
            <div class="mpl-title">
              <div class="mpl-tag">å®å½“é­”æ–¹</div>
              é­”æ–¹æ–°æ‰‹è‡ªç ”ï¼Œå‡†å¤‡åŒ…å« N å¤šè¾…åŠ©åŠŸèƒ½çš„åŸºç¡€é­”æ–¹
            </div>
            <div class="mpl-features">
              <div class="mpl-sales">æ³¨å†Œç”¨æˆ·5k</div>
              <div>æ˜é‡‘å°å†ŒåŒ…æ•™åŒ…ä¼š</div>
            </div>
            <div class="mpl-info">
              <div class="mpl-save">
                star
                <div>112</div>
              </div>
            </div>
          </div>
        </div>
        <div class="mpl-item">
          <div class="mpl-img">
            <img src="https://pic1.zhimg.com/80/v2-738c26db234dbcb4c076b2103e2534df_720w.png" />
          </div>
          <div class="mpl-detail">
            <div class="mpl-title">
              <div class="mpl-tag">æ˜é‡‘å°å†Œ</div>
              åŸºäº ThreeJS æ¡†æ¶çš„é­”æ–¹å¾®ä¿¡å°æ¸¸æˆå®è·µ
            </div>
            <div class="mpl-features">
              <div class="mpl-sales">ä»0åˆ°1</div>
              <div>å®ç°ç‚«é…·é­”æ–¹å¾®ä¿¡å°æ¸¸æˆ</div>
            </div>
            <div class="mpl-info">
              <div class="mpl-save">
                å·²å”®
                <div>1000</div>
              </div>
              <div class="mpl-text">Â¥9.9</div>
            </div>
          </div>
        </div>
      </div>
      <div class="mps-end">
        <div class="mpse-qrcode">
          <img src="https://pic1.zhimg.com/80/v2-29a530f8c148668b9a2b746c7a5783ba_720w.png" />
        </div>
        <div class="mpse-text">
          <div>
            <div class="mpse-no">1</div>
            ä¿å­˜å›¾ç‰‡åˆ°ç›¸å†Œ
          </div>
          <div>
            <div class="mpse-no">2</div>
            æ‰‹æœºæ‰«ä¸€æ‰«å³å¯çœ‹è§
          </div>
        </div>
        <div class="mpse-logo">
          <div></div>
        </div>
      </div>
    </div>

    <div class="mps-btns">
      <div id="screenshotBtn">æˆªå±ç”Ÿæˆå›¾ç‰‡å¹¶é¢„è§ˆ</div>
    </div>
  </div>

  <div class="temp-preview">
    <div><img src="" alt=""></div>
  </div>

  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.3.4/vconsole.min.js"></script>
  <script src="../../build/index-web.min.js"></script>
  <script>
    // https://demo.lione.me/simple-screenshot/test-1.html?pub
    window.onload = function () {
      let vConsole = new VConsole();
      let isPub = window.location.search.indexOf("?pub") == 0 ? true : false; //æ˜¯å¦æ˜¯ pub æ¨¡å¼

      // é¡µé¢å…ƒç´ 
      let $screenshotBtn = document.querySelector("#screenshotBtn");
      if (!isPub) {
        $screenshotBtn.innerHTML = "æˆªå±ç”Ÿæˆå›¾ç‰‡å¹¶ä¸‹è½½åˆ°æœ¬åœ°";
      }
      let $previewDialog = document.querySelector(".temp-preview");
      let $previewImg = document.querySelector(".temp-preview img");

      // Simple-Screenshot åˆå§‹åŒ–
      let imgType = "jpeg";
      let screenshot = new SimpleScreenshot({
        debug: isPub ? false : true, // è°ƒè¯•æ¨¡å¼ï¼Œç»„ä»¶ä»£ç ä¸­ä¼šæ‰§è¡Œ log å‡½æ•°
        imgType: imgType, // å›¾ç‰‡ç±»å‹
        //puppeteerServer: 'http://127.0.0.1:8000/simple-screenshot', // æœ¬åœ°æˆªå±æœåŠ¡
        puppeteerServer: "https://dom2img.lione.me/simple-screenshot",
        puppeteerGlobalFont: "PingFang", // puppeteer æˆªå±æœåŠ¡å…¨å±€å­—ä½“
        //forceScreenshotType: "server", // å¼ºåˆ¶ä½¿ç”¨ puppeteer æˆªå±æœåŠ¡
        devicePixelRatio: window.devicePixelRatio, // è®¾å¤‡åƒç´ æ¯”
        log: function (msg) {
          console.log(msg);
          console.log(msg.svg);
        },
        error: function (err) {
          console.log(err);
        },
      });

      // æˆªå±
      $screenshotBtn.addEventListener("click", function () {
        let timestamps = [window.performance.now()];
        screenshot.toIMG(".mps-content", function (img) {
          timestamps.push(window.performance.now());
          console.log(timestamps[1] - timestamps[0]); // calc timestamp
          if (!isPub) { //dev
            downloadCanvas(img.canvas, "demo");
          } else {
            $previewDialog.style.display = 'flex';
            $previewImg.src = img.base64;
          }
        });
      });

      // éšè—
      $previewDialog.addEventListener("click", function () {
        $previewDialog.style.display = 'none';
      })

      //ä¸‹è½½ canvas
      function downloadCanvas($canvas, name) {
        let url = $canvas.toDataURL(`image/${imgType}`);
        let a = document.createElement("a");
        let event = new MouseEvent("click");
        a.download = name;
        a.href = url;
        a.dispatchEvent(event);
      }

      // wejssdk
      let xhr = new XMLHttpRequest();
      xhr.open(
        "GET",
        "https://cloudbase-server-2fzcjh0e646d512.service.tcloudbase.com/koa-starter/wejssdk?url=https://demo.lione.me/simple-screenshot/test-1.html?pub"
      );
      xhr.responseType = "json";
      xhr.onerror = function (err) {
        console.log(err);
      };
      xhr.ontimeout = function (err) {
        console.log(err);
      };
      xhr.onload = function () {
        let res = xhr.response;
        wx.config({
          // debug: true,
          appId: res.data.appId, // å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
          nonceStr: res.data.nonceStr, // ç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
          timestamp: res.data.timestamp, // ç”Ÿæˆç­¾åçš„éšæœºä¸²
          signature: res.data.signature, // ç­¾å
          jsApiList: [], // éœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨
        });
      };
      xhr.send();

      wx.ready(function () {});
    };
  </script>
</body>

</html>